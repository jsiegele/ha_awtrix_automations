alias: Awtrix Auto Charginginfos
description: ""
triggers:
  - trigger: time_pattern
    minutes: /5
conditions:
  - condition: state
    entity_id: switch.ikea_steckdose_awtrix_wohnzimmer
    state:
      - "on"
  - condition: template
    value_template: |
      {{ states.sensor.charger_status_connector.state != "Available" }}
    alias: Wenn der Charger Status ungleich Available ist
    enabled: true
actions:
  - action: mqtt.publish
    metadata: {}
    data:
      evaluate_payload: false
      qos: 0
      retain: false
      payload: |-
        {% set state = states('sensor.charger_status_connector') %}
        {% set icon = '59852' if state == "Charging" else '59663' %}

        {% set sensor_mapping = {
          'sensor.charger_power_active_import': 'W',
          'sensor.audi_q4_e_tron_primary_engine_percent': '%',
        } %}

        {%- set ns = namespace(notifications=[]) -%}
        {%- for sensor, unit in sensor_mapping.items() -%}
          {%- set text = states(sensor) | float | round(1) ~ unit -%}
          {%- if unit == 'W' -%}
            {%- set text = ('%.1fkW' | format(states(sensor) | float/1000 )) -%}
          {%- else -%}
            {%- set text = states(sensor) ~ unit -%}
          {%- endif -%}
          {%- set notification = {
            "text": text,
            "rainbow": false,
            "icon": icon,
            "duration": 10,
            "pushIcon": 0,
            "lifetime": 2000,
            "repeat": 6
          } -%}
          {%- set ns.notifications = ns.notifications + [notification] -%}
        {%- endfor -%}
        {{ ns.notifications | to_json }}
      topic: awtrix_b3d1fc/custom/carchargerinfos
mode: single
